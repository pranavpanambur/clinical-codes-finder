<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Clinical Codes Finder</title>

    <!-- Markdown renderer + XSS sanitizer -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>

    <style>
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; max-width: 880px; margin: 24px auto; padding: 0 16px; }
      .card { border: 1px solid #e5e7eb; border-radius: 16px; padding: 16px; margin: 12px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.03); background: #fff; }
      .row { display: flex; gap: 10px; align-items: center; }
      input[type=text] { flex: 1; padding: 12px 14px; border-radius: 12px; border: 1px solid #cbd5e1; font-size: 16px; }
      button { padding: 10px 14px; border-radius: 12px; border: 1px solid #0ea5e9; background: white; cursor: pointer; }
      button:hover { background: #f0f9ff; }
      button[disabled] { opacity: .6; cursor: not-allowed; }
      code { background: #f8fafc; padding: 2px 6px; border-radius: 6px; }
      .muted { color: #6b7280; }
      .grid { display: grid; grid-template-columns: repeat( auto-fit, minmax(240px, 1fr) ); gap: 12px; }
      .tag { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #e5e7eb; font-size: 12px; margin-right: 6px; }
      .sys { font-weight: 700; margin-bottom: 8px; }
      .small { font-size: 12px; }

      /* Markdown styling for summary */
      .markdown { line-height: 1.55; color: #1f2937; background:#fafafa; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; }
      .markdown h1, .markdown h2, .markdown h3 { margin: .75rem 0 .35rem; }
      .markdown p { margin: .4rem 0; }
      .markdown ul, .markdown ol { padding-left: 1.25rem; margin: .5rem 0; }
      .markdown li { margin: .25rem 0; }
      .markdown strong { font-weight: 600; }
      .markdown code { background:#f6f8fa; padding:.1rem .25rem; border-radius:4px; }
      .markdown a { color:#2563eb; text-decoration: underline; }
    </style>
  </head>
  <body>
    <h1>ðŸ©º Clinical Codes Finder</h1>
    <p class="muted">Enter a clinical phrase, then I'll fetch and rank code candidates across ICD-10-CM, LOINC, RxTerms, HCPCS, UCUM, and HPO.</p>

    <div class="card">
      <div class="row">
        <input id="q" type="text" placeholder="e.g., glucose test, metformin 500 mg, ataxia" />
        <button id="go">Search</button>
      </div>
    </div>

    <div id="out"></div>

    <script>
      const API_BASE = 'http://localhost:8000'; 
      const out = document.getElementById('out');
      const q = document.getElementById('q');
      const go = document.getElementById('go');

      // Markdown instance
      const md = window.markdownit({ breaks: true });

      // Allow pressing Enter to submit
      q.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') go.click();
      });

      go.onclick = async () => {
        const query = q.value.trim();
        if (!query) return;

        // show loading & disable button
        out.innerHTML = '<div class="card">Searchingâ€¦</div>';
        go.disabled = true;

        try {
          const res = await fetch(`${API_BASE}/search`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({query})
          });

          if (!res.ok) {
            const txt = await res.text().catch(() => '');
            throw new Error(`Backend returned ${res.status}. ${txt || ''}`.trim());
          }

          const data = await res.json();

          // Prefer server provided grouping
          let groups = data.grouped || {};
          if (!groups || !Object.keys(groups).length) {
            groups = {};
            (data.results || []).forEach(r => {
              groups[r.system] = groups[r.system] || [];
              groups[r.system].push(r);
            });
          }

          // Render groups
          const htmlGroups = Object.entries(groups).map(([sys, items]) => `
            <div class="card">
              <div class="sys">${sys} <span class="muted small">(${items.length})</span></div>
              <div class="grid">
                ${items.map(i => `
                  <div class="card">
                    <div><span class="tag">${i.system}</span> <code>${i.code}</code></div>
                    <div>${i.display || ''}</div>
                    ${
                      i.extras && Object.keys(i.extras).length
                        ? `<div class="small muted">${
                            Object.entries(i.extras)
                              .map(([k,v]) => `<span class="tag">${k}: ${Array.isArray(v) ? v.join(' | ') : v}</span>`)
                              .join(' ')
                          }</div>`
                        : ''
                    }
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('');

          // Render summary as Markdown 
          const rawSummary = data.summary || '';
          const rendered = md.render(rawSummary);
          const safe = DOMPurify.sanitize(rendered, { USE_PROFILES: { html: true } });

          out.innerHTML = `
            <div class="markdown">
              ${safe || '<span class="muted">No summary available for this query.</span>'}
            </div>
            ${htmlGroups || ''}
          `;

          // Make any links open in a new tab
          out.querySelectorAll('.markdown a').forEach(a => a.setAttribute('target', '_blank'));
        } catch (e) {
          out.innerHTML = '<div class="card">Error: ' + (e.message || e) + '</div>';
        } finally {
          go.disabled = false;
        }
      };
    </script>
  </body>
</html>
